

<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying Payment | Karatasi Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; height: 100vh; display: flex; align-items: center; justify-content: center; color: #e2e8f0; }
        .payment-card { 
            background: #1e293b; border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 1.5rem; padding: 3rem; text-align: center; max-width: 450px; width: 100%;
        }
        .spinner-custom {
            width: 3rem; height: 3rem; border: 0.25em solid #4f46e5;
            border-right-color: transparent; border-radius: 50%;
            animation: spinner-border .75s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="payment-card shadow-lg">
        <div id="status-icon-box">
            {% if status == 'Success' %}
                <div class="spinner-custom mx-auto" id="loading-spinner"></div>
            {% else %}
                <div style="font-size: 3rem;">❌</div>
            {% endif %}
        </div>

        <h2 id="status-title" class="fw-bold mb-3">
            {% if status == 'Success' %}
                Verifying Payment...
            {% else %}
                Request Failed
            {% endif %}
        </h2>

        <p id="status-msg" class="text-secondary">
            {% if status == 'Success' %}
                Please enter your M-Pesa PIN on your phone. We are waiting for the confirmation.
            {% else %}
                {{ message }}
            {% endif %}
        </p>

        <hr class="my-4 opacity-10">

        <a href="{% url 'upload_scan' %}" class="btn btn-outline-secondary w-100 py-2">
            Return to Dashboard
        </a>
    </div>

    {% if status == 'Success' %}
    <script>
        // We get the doc_id from the view context
        const docId = "{{ doc_id }}";
        
        // This function checks the server every 3 seconds
        const checkMpesa = setInterval(async () => {
            try {
                // We call the 'check_payment_status' view
                const response = await fetch(`/check-status/${docId}/`);
                const data = await response.json();

                // If the server says the payment is done
                if (data.is_paid === true) {
                    clearInterval(checkMpesa); // Stop the loop

                    // Update the UI
                    document.getElementById('loading-spinner').style.display = 'none';
                    document.getElementById('status-icon-box').innerHTML = "<div style='font-size: 4rem; margin-bottom: 1rem;'>✅</div>";
                    document.getElementById('status-title').innerText = "Payment Confirmed!";
                    document.getElementById('status-title').style.color = "#10b981";
                    document.getElementById('status-msg').innerText = "Your document is now unlocked. Redirecting...";

                    // Redirect after a short delay
                    setTimeout(() => {
                        window.location.href = "{% url 'upload_scan' %}";
                    }, 2500);
                }
            } catch (error) {
                console.error("Polling error:", error);
            }
        }, 3000); // Check every 3 seconds

        // Stop checking after 2 minutes (Safety timeout)
        setTimeout(() => clearInterval(checkMpesa), 120000);
    </script>
    {% endif %}

</body>
</html>